<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1d23">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>gDAS Survey</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #1a1d23;
  --surface: #23272f;
  --surface2: #2a2f38;
  --border: #3a3f4a;
  --text: #e8eaed;
  --text2: #9aa0a8;
  --accent: #4da6ff;
  --green: #34c759;
  --red: #ff453a;
  --orange: #ff9f0a;
  --radius: 8px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg); color: var(--text);
  font-size: 14px; min-height: 100vh;
}

.topbar {
  position: sticky; top:0; z-index:1000;
  background: var(--surface); border-bottom:1px solid var(--border);
  padding: 8px 12px; display:flex; align-items:center; justify-content:space-between;
}
.topbar h1 { font-size:16px; font-weight:700; color:var(--accent); letter-spacing:.5px; }
.topbar .status { font-size:11px; color:var(--text2); display:flex; align-items:center; gap:6px; }
.dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
.dot-on { background:var(--green); } .dot-off { background:var(--red); }

.tabbar { display:flex; background:var(--surface); border-bottom:1px solid var(--border); position:sticky; top:37px; z-index:999; }
.tabbar button {
  flex:1; padding:10px 0; background:none; border:none;
  color:var(--text2); font-size:12px; font-weight:600;
  cursor:pointer; border-bottom:2px solid transparent; transition:all .2s;
}
.tabbar button.active { color:var(--accent); border-bottom-color:var(--accent); }

.panel { display:none; padding:12px; max-width:600px; margin:0 auto; }
.panel.active { display:block; }
#tab-map.active { display:block; max-width:none; padding:0; }

.section {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:14px; margin-bottom:12px;
}
.section h3 {
  font-size:12px; color:var(--accent); text-transform:uppercase;
  letter-spacing:1px; margin-bottom:10px; font-weight:700;
}
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.form-grid .full { grid-column:1/-1; }
label {
  display:block; font-size:11px; color:var(--text2); margin-bottom:4px;
  font-weight:600; text-transform:uppercase; letter-spacing:.5px;
}
select,input[type="text"],input[type="number"],input[type="date"],
input[type="time"],textarea {
  width:100%; padding:9px 10px; background:var(--surface2);
  border:1px solid var(--border); border-radius:6px;
  color:var(--text); font-size:14px; font-family:inherit; outline:none;
}
select:focus,input:focus,textarea:focus { border-color:var(--accent); }
textarea { resize:vertical; min-height:60px; }
select { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239aa0a8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; padding-right:30px; }
input[type="file"]::file-selector-button {
  background:var(--accent); color:#fff; border:none;
  padding:6px 14px; border-radius:6px; cursor:pointer;
  font-size:13px; margin-right:10px;
}
.duration-ok { color:var(--green); }
.duration-bad { color:var(--red); font-weight:700; }

.btn {
  display:inline-flex; align-items:center; justify-content:center; gap:6px;
  padding:10px 16px; border:none; border-radius:6px;
  font-size:14px; font-weight:600; cursor:pointer; transition:all .15s;
  font-family:inherit;
}
.btn-primary { background:var(--accent); color:#fff; }
.btn-primary:disabled { background:var(--border); color:var(--text2); cursor:not-allowed; }
.btn-green { background:var(--green); color:#fff; }
.btn-red { background:var(--red); color:#fff; }
.btn-orange { background:var(--orange); color:#1a1d23; }
.btn-sm { padding:5px 10px; font-size:12px; }
.btn-full { width:100%; }
.btn-row { display:flex; gap:8px; margin-top:10px; }
.btn-ghost { background:var(--surface2); color:var(--text); }

.log-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:10px 12px; margin-bottom:8px;
  cursor:pointer; transition:border-color .2s;
}
.log-card:hover { border-color:var(--accent); }
.log-card.editing { border-color:var(--green); background:#1e2a1e; }
.log-card .log-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
.log-card .log-title { font-weight:700; font-size:14px; }
.log-card .log-meta { font-size:12px; color:var(--text2); line-height:1.6; }
.log-card .log-actions { display:flex; gap:6px; margin-top:6px; }

.gps-bar {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:6px; padding:6px 10px; margin-bottom:12px;
  font-size:12px; color:var(--text2); display:flex; align-items:center; gap:8px;
}

.toast {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:var(--surface); border:1px solid var(--border);
  padding:10px 20px; border-radius:8px; font-size:13px;
  box-shadow:0 4px 20px rgba(0,0,0,.4); z-index:9999;
  opacity:0; transition:opacity .3s; pointer-events:none;
}
.toast.show { opacity:1; }
.empty { text-align:center; padding:40px 20px; color:var(--text2); }
.empty .icon { font-size:32px; margin-bottom:8px; }
.badge { background:var(--accent); color:#fff; border-radius:10px; padding:1px 7px; font-size:11px; font-weight:700; margin-left:6px; }

/* ── Map ── */
#mapContainer { width:100%; height:calc(100vh - 95px); }
.map-toolbar {
  background:var(--surface); border-bottom:1px solid var(--border);
  padding:8px 12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px;
}
.map-toolbar select, .map-toolbar input[type="text"] { padding:5px 8px; font-size:12px; width:auto; min-width:0; }
.map-toolbar input[type="text"] { width:55px; }
.map-toolbar label { margin:0; font-size:11px; display:inline-flex; align-items:center; gap:4px; }

.pulse-marker { width:20px; height:20px; background:lime; border-radius:50%; animation:pulse 2s infinite; }
@keyframes pulse {
  0% { box-shadow:0 0 0 0 rgba(0,255,0,0.7); }
  70% { box-shadow:0 0 0 15px rgba(0,255,0,0); }
  100% { box-shadow:0 0 0 0 rgba(0,255,0,0); }
}
.leaflet-popup-content-wrapper { background:var(--surface); color:var(--text); border-radius:8px; }
.leaflet-popup-tip { background:var(--surface); }
.leaflet-popup-content { font-size:12px; line-height:1.6; }

@media(max-width:400px) {
  .form-grid { grid-template-columns:1fr; }
  .form-grid .full { grid-column:1; }
}
</style>
</head>
<body>

<div class="topbar">
  <h1>gDAS Survey</h1>
  <div class="status">
    <span class="dot" id="gpsDot"></span>
    <span id="gpsText">GPS...</span>
  </div>
</div>

<div class="tabbar">
  <button class="active" onclick="switchTab('form')">Log Entry</button>
  <button onclick="switchTab('map')">Map</button>
  <button onclick="switchTab('logs')">Logs <span class="badge" id="logCount">0</span></button>
  <button onclick="switchTab('settings')">Settings</button>
</div>

<!-- ═══ FORM TAB ═══ -->
<div class="panel active" id="tab-form">
  <div class="gps-bar">
    <span style="font-size:16px">&#x1F4E1;</span>
    <span id="gpsInfo">Waiting for GPS fix...</span>
  </div>

  <div class="section">
    <h3>Sensor Selection</h3>
    <div class="form-grid">
      <div><label>Area</label><select id="selArea" onchange="onAreaChange()"><option value="">-- select --</option></select></div>
      <div><label>Line</label><select id="selLine" onchange="onLineChange()"><option value="">-- select --</option></select></div>
      <div><label>Sensor Type</label><select id="selType" onchange="onTypeChange()"><option value="">-- select --</option></select></div>
      <div><label>Type Detail</label><select id="selDetail" onchange="onDetailChange()"><option value="">-- select --</option></select></div>
      <div class="full"><label>Sensor Code</label><select id="selCode"><option value="">-- select --</option></select></div>
      <div class="full" id="coilRow" style="display:none"><label>Coil S/N</label><input type="text" id="inCoil" placeholder="Enter coil serial number"></div>
    </div>
  </div>

  <div class="section">
    <h3>Deployment Info</h3>
    <div class="form-grid">
      <div><label>gDAS S/N</label><input type="number" id="inGdas" placeholder="e.g. 189"></div>
      <div><label>Channel</label><select id="selChannel"><option value="">-- select --</option><option value="1">1</option><option value="2">2</option></select></div>
    </div>
  </div>

  <div class="section">
    <h3>Timing</h3>
    <div class="form-grid">
      <div><label>Install Date</label><input type="date" id="inInstDate"></div>
      <div><label>Install Time</label><input type="time" id="inInstTime"></div>
      <div><label>Pickup Date</label><input type="date" id="inPickDate"></div>
      <div><label>Pickup Time</label><input type="time" id="inPickTime"></div>
      <div class="full"><label>Duration (hours)</label><input type="text" id="inDuration" readonly placeholder="Auto-calculated"></div>
    </div>
  </div>

  <div class="section">
    <h3>Comments</h3>
    <textarea id="inComments" placeholder="Any notes..."></textarea>
  </div>

  <div class="btn-row"><button class="btn btn-primary btn-full" id="btnSubmit" onclick="submitLog()" disabled>Submit Log</button></div>
  <div class="btn-row" id="editBtns" style="display:none"><button class="btn btn-orange btn-full" onclick="cancelEdit()">Cancel Edit / New</button></div>
</div>

<!-- ═══ MAP TAB ═══ -->
<div class="panel" id="tab-map">
  <div class="map-toolbar">
    <label>Datum <select id="mapDatum" onchange="saveDatumZone()">
      <option value="">--</option><option value="WGS84">WGS84</option><option value="GDA94">GDA94</option>
      <option value="PSAD56">PSAD56</option><option value="NAD83">NAD83</option>
    </select></label>
    <label>Zone <input type="text" id="mapZone" placeholder="19S" oninput="saveDatumZone()"></label>
    <button class="btn btn-primary btn-sm" onclick="plotSensors()">Plot</button>
    <button class="btn btn-ghost btn-sm" onclick="clearMap()">Clear</button>
    <button class="btn btn-ghost btn-sm" onclick="resetMapView()">Reset</button>
    <label style="cursor:pointer"><input type="checkbox" id="chkLabels" checked onchange="plotSensors()"> Labels</label>
  </div>
  <div id="mapContainer"></div>
</div>

<!-- ═══ LOGS TAB ═══ -->
<div class="panel" id="tab-logs">
  <div id="logsList"></div>
</div>

<!-- ═══ SETTINGS TAB ═══ -->
<div class="panel" id="tab-settings">
  <div class="section">
    <h3>Import Sensor Plan</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:10px">Load .xlsx with columns: area, line, sensorType, sensorTypeDetail, sensorCode, UTMx, UTMy</p>
    <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileImport(event)">
    <div id="importStatus" style="margin-top:8px;font-size:12px;color:var(--text2)"></div>
  </div>
  <div class="section">
    <h3>Export Logs</h3>
    <div class="btn-row"><button class="btn btn-green btn-full" onclick="exportXLSX()">Export as .xlsx</button></div>
    <div class="btn-row"><button class="btn btn-primary btn-full" onclick="exportCSV()">Export as .csv</button></div>
  </div>
  <div class="section">
    <h3>Data Management</h3>
    <div class="btn-row"><button class="btn btn-red btn-full" onclick="clearAllLogs()">Clear All Logs</button></div>
    <div class="btn-row"><button class="btn btn-orange btn-full" onclick="clearSensorData()">Clear Sensor Plan</button></div>
    <div id="dataStats" style="margin-top:10px;font-size:12px;color:var(--text2)"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════
// STATE
// ═══════════════════════════════════
var sensorData = [], logs = [], editingIndex = null;
var userLat = null, userLon = null, gpsAccuracy = null;
var leafletMap = null, sensorMarkers = [], userMarker = null;

// ═══════════════════════════════════
// INIT
// ═══════════════════════════════════
(function init() {
  try { sensorData = JSON.parse(localStorage.getItem('sensorData')) || []; } catch(e) { sensorData = []; }
  try { logs = JSON.parse(localStorage.getItem('sensorLogs')) || []; } catch(e) { logs = []; }

  var d = localStorage.getItem('selectedDatum'), z = localStorage.getItem('utmZone');
  if (d) document.getElementById('mapDatum').value = d;
  if (z) document.getElementById('mapZone').value = z;

  var now = new Date();
  document.getElementById('inInstDate').value = now.toISOString().split('T')[0];
  document.getElementById('inInstTime').value = now.toTimeString().slice(0,5);

  populateAreas(); updateLogCount(); updateDataStats();

  ['inInstDate','inInstTime','inPickDate','inPickTime'].forEach(function(id) {
    document.getElementById(id).addEventListener('input', calcDuration);
  });
  document.querySelectorAll('#tab-form select, #tab-form input, #tab-form textarea').forEach(function(el) {
    el.addEventListener('input', validateForm);
    el.addEventListener('change', validateForm);
  });

  startGPS();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(function(r) {
      console.log('SW registered:', r.scope);
    }).catch(function(e) { console.log('SW reg failed:', e); });
  }
})();

// ═══════════════════════════════════
// GPS
// ═══════════════════════════════════
function startGPS() {
  if (!navigator.geolocation) { setGPSStatus(false, 'GPS not available'); return; }
  navigator.geolocation.watchPosition(
    function(pos) {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      gpsAccuracy = pos.coords.accuracy;
      setGPSStatus(true, userLat.toFixed(5) + ', ' + userLon.toFixed(5) + ' (+-' + Math.round(gpsAccuracy) + 'm)');
      refreshCodeDropdown();
      updateUserMarker();
    },
    function(err) { setGPSStatus(false, 'No GPS fix (' + err.message + ')'); },
    { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 }
  );
}

function setGPSStatus(ok, text) {
  document.getElementById('gpsDot').className = 'dot ' + (ok ? 'dot-on' : 'dot-off');
  document.getElementById('gpsText').textContent = ok ? 'GPS' : 'No GPS';
  document.getElementById('gpsInfo').textContent = text;
}

// ═══════════════════════════════════
// UTM -> LatLon
// ═══════════════════════════════════
function utmToLatLon(easting, northing, zoneStr) {
  if (!zoneStr) return null;
  var m = zoneStr.match(/(\d+)\s*([NSns]?)/);
  if (!m) return null;
  var zone = parseInt(m[1]), south = (m[2]||'').toUpperCase() === 'S';
  var a = 6378137.0, f = 1/298.257223563, k0 = 0.9996;
  var e = Math.sqrt(2*f - f*f), e2 = e*e, ep2 = e2/(1-e2);
  var x = easting - 500000.0, y = south ? northing - 10000000.0 : northing;
  var M = y/k0, mu = M/(a*(1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
  var e1 = (1-Math.sqrt(1-e2))/(1+Math.sqrt(1-e2));
  var phi1 = mu + (3*e1/2-27*e1*e1*e1/32)*Math.sin(2*mu)
    + (21*e1*e1/16-55*e1*e1*e1*e1/32)*Math.sin(4*mu)
    + (151*e1*e1*e1/96)*Math.sin(6*mu);
  var sp=Math.sin(phi1), cp=Math.cos(phi1), tp=Math.tan(phi1);
  var C1=ep2*cp*cp, T1=tp*tp, N1=a/Math.sqrt(1-e2*sp*sp);
  var R1=a*(1-e2)/Math.pow(1-e2*sp*sp,1.5), D=x/(N1*k0);
  var lat = phi1-(N1*tp/R1)*(D*D/2-(5+3*T1+10*C1-4*C1*C1-9*ep2)*D*D*D*D/24
    +(61+90*T1+298*C1+45*T1*T1-252*ep2-3*C1*C1)*D*D*D*D*D*D/720);
  var lon = (D-(1+2*T1+C1)*D*D*D/6+(5-2*C1+28*T1-3*C1*C1+8*ep2+24*T1*T1)*D*D*D*D*D/120)/cp;
  var lon0 = ((zone-1)*6-180+3)*Math.PI/180;
  return { lat:lat*180/Math.PI, lon:(lon+lon0)*180/Math.PI };
}

function distanceKm(lat1,lon1,lat2,lon2) {
  var R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  var a2=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  return R*2*Math.atan2(Math.sqrt(a2),Math.sqrt(1-a2));
}

function getSensorDistance(sensor) {
  if (userLat===null||userLon===null||!sensor.UTMx||!sensor.UTMy) return Infinity;
  var zone = document.getElementById('mapZone').value;
  if (!zone) return Infinity;
  var ll = utmToLatLon(parseFloat(sensor.UTMx), parseFloat(sensor.UTMy), zone);
  return ll ? distanceKm(userLat,userLon,ll.lat,ll.lon) : Infinity;
}

function formatDist(km) {
  if (!isFinite(km)) return '';
  return km < 1 ? Math.round(km*1000)+'m' : km.toFixed(1)+'km';
}

// ═══════════════════════════════════
// MAP
// ═══════════════════════════════════
function initMap() {
  if (leafletMap) return;
  var sc = localStorage.getItem('mapCenter'), sz = localStorage.getItem('mapZoom');
  var center = sc ? JSON.parse(sc) : [-33.86,151.21];
  var zoom = sz ? parseInt(sz) : 12;

  leafletMap = L.map('mapContainer').setView(center, zoom);

  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'OSM', maxZoom:19 });
  var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Esri', maxZoom:19 });
  osm.addTo(leafletMap);
  L.control.layers({'OpenStreetMap':osm,'Esri Satellite':esri}).addTo(leafletMap);

  leafletMap.on('moveend', function() {
    var c = leafletMap.getCenter();
    localStorage.setItem('mapCenter', JSON.stringify([c.lat,c.lng]));
    localStorage.setItem('mapZoom', leafletMap.getZoom().toString());
  });

  updateUserMarker();
  if (sensorData.length && document.getElementById('mapZone').value && document.getElementById('mapDatum').value) {
    setTimeout(plotSensors, 200);
  }
}

function updateUserMarker() {
  if (!leafletMap || userLat===null) return;
  var icon = L.divIcon({ html:'<div class="pulse-marker"></div>', iconSize:[20,20], iconAnchor:[10,10], className:'' });
  if (userMarker) { userMarker.setLatLng([userLat,userLon]); }
  else {
    userMarker = L.marker([userLat,userLon],{icon:icon,zIndexOffset:1000})
      .bindPopup('<strong>You are here</strong><br>'+userLat.toFixed(6)+', '+userLon.toFixed(6))
      .addTo(leafletMap);
  }
}

function plotSensors() {
  if (!leafletMap) return;
  var zone = document.getElementById('mapZone').value;
  var datum = document.getElementById('mapDatum').value;
  if (!zone||!datum) { toast('Set datum & zone first'); return; }
  var showLabels = document.getElementById('chkLabels').checked;

  sensorMarkers.forEach(function(m){ leafletMap.removeLayer(m); });
  sensorMarkers = [];

  try { logs = JSON.parse(localStorage.getItem('sensorLogs'))||[]; } catch(e){ logs=[]; }

  var grouped = {};
  sensorData.forEach(function(sensor) {
    if (!sensor.UTMx||!sensor.UTMy) return;
    var key = sensor.UTMx+','+sensor.UTMy;
    var ll = utmToLatLon(parseFloat(sensor.UTMx),parseFloat(sensor.UTMy),zone);
    if (!ll) return;
    var hasLog = logs.some(function(log){return log.sensorCode===sensor.sensorCode;});
    if (!grouped[key]) grouped[key] = {lat:ll.lat, lon:ll.lon, sensors:[]};
    grouped[key].sensors.push({
      area:sensor.area, line:sensor.line, sensorType:sensor.sensorType,
      sensorTypeDetail:sensor.sensorTypeDetail, sensorCode:sensor.sensorCode, hasLog:hasLog
    });
  });

  var groups = Object.values(grouped), bounds = [];

  groups.forEach(function(group) {
    var isH = group.sensors.every(function(s){return ['Hx','Hy','Hz'].indexOf(s.sensorType)!==-1;});
    var hasAnyLog = group.sensors.some(function(s){return s.hasLog;});
    var col = hasAnyLog ? '#34c759' : '#4da6ff';
    var shape = isH ? '' : 'border-radius:50%;';
    var sz = 14;

    var labels = '';
    if (showLabels) {
      group.sensors.forEach(function(s,i) {
        labels += '<div style="position:absolute;top:'+(-18-i*14)+'px;left:16px;'
          +'font-size:11px;font-weight:bold;cursor:pointer;white-space:nowrap;'
          +'color:'+(s.hasLog?'#34c759':'#fff')+';text-shadow:0 0 3px #000;"'
          +' onclick="event.stopPropagation();prefillFromMap(\''+btoa(JSON.stringify(s))+'\')">'
          +esc(s.sensorCode)+'</div>';
      });
    }

    var html = '<div style="position:relative;width:'+sz+'px;height:'+sz+'px;background:'+col+';'+shape+'border:2px solid white;">'+labels+'</div>';
    var icon = L.divIcon({html:html, iconSize:[sz+80,sz+40], iconAnchor:[sz/2,sz/2], className:''});

    var popup = group.sensors.map(function(s,i) {
      return '<strong>'+esc(s.area)+' / '+esc(s.line)+'</strong><br>'
        +esc(s.sensorType)+' '+esc(s.sensorTypeDetail)+'<br>'
        +'<strong>'+esc(s.sensorCode)+'</strong> '
        +(s.hasLog?'<span style="color:#34c759">Logged</span>':'<span style="color:#ff453a">Not logged</span>')
        +'<br><a href="#" onclick="event.preventDefault();prefillFromMap(\''+btoa(JSON.stringify(s))+'\');" style="color:var(--accent)">Log this sensor</a>'
        +(i<group.sensors.length-1?'<hr style="border-color:#3a3f4a;margin:4px 0">':'');
    }).join('');

    var marker = L.marker([group.lat,group.lon],{icon:icon}).bindPopup(popup).addTo(leafletMap);
    sensorMarkers.push(marker);
    bounds.push([group.lat,group.lon]);
  });

  if (bounds.length) leafletMap.fitBounds(bounds,{padding:[40,40],maxZoom:15});
  toast(groups.length+' locations plotted');
}

function clearMap() {
  sensorMarkers.forEach(function(m){leafletMap.removeLayer(m);}); sensorMarkers=[];
}

function resetMapView() {
  if (!sensorMarkers.length) return;
  var b = sensorMarkers.map(function(m){return m.getLatLng();});
  leafletMap.fitBounds(b,{padding:[40,40],maxZoom:15});
}

function prefillFromMap(b64) {
  try {
    var s = JSON.parse(atob(b64));
    document.getElementById('selArea').value = s.area||''; onAreaChange();
    setTimeout(function(){
      document.getElementById('selLine').value = s.line||''; onLineChange();
      setTimeout(function(){
        document.getElementById('selType').value = s.sensorType||''; onTypeChange();
        setTimeout(function(){
          document.getElementById('selDetail').value = s.sensorTypeDetail||''; onDetailChange();
          setTimeout(function(){
            var sel = document.getElementById('selCode');
            for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===s.sensorCode){sel.selectedIndex=i;break;}}
            validateForm(); switchTab('form');
          },30);
        },30);
      },30);
    },30);
  } catch(e){ console.error('prefill err',e); }
}

// ═══════════════════════════════════
// CASCADING DROPDOWNS
// ═══════════════════════════════════
function populateAreas() {
  var sel=document.getElementById('selArea'), cur=sel.value;
  var areas = unique(sensorData.map(function(s){return s.area}).filter(Boolean));
  sel.innerHTML='<option value="">-- select --</option>';
  areas.forEach(function(a){sel.innerHTML+='<option value="'+esc(a)+'">'+esc(a)+'</option>';});
  sel.value=cur;
}
function onAreaChange() {
  var area=document.getElementById('selArea').value, sel=document.getElementById('selLine');
  var lines=unique(sensorData.filter(function(s){return s.area===area}).map(function(s){return s.line}).filter(Boolean));
  sel.innerHTML='<option value="">-- select --</option>';
  lines.forEach(function(l){sel.innerHTML+='<option value="'+esc(l)+'">'+esc(l)+'</option>';});
  if(lines.length===1) sel.value=lines[0];
  onLineChange();
}
function onLineChange() {
  var area=document.getElementById('selArea').value, line=document.getElementById('selLine').value, sel=document.getElementById('selType');
  var types=unique(sensorData.filter(function(s){return s.area===area&&s.line===line}).map(function(s){return s.sensorType}).filter(Boolean));
  sel.innerHTML='<option value="">-- select --</option>';
  types.forEach(function(t){sel.innerHTML+='<option value="'+esc(t)+'">'+esc(t)+'</option>';});
  if(types.length===1) sel.value=types[0];
  onTypeChange();
}
function onTypeChange() {
  var area=document.getElementById('selArea').value, line=document.getElementById('selLine').value, type=document.getElementById('selType').value;
  var sel=document.getElementById('selDetail');
  var details=unique(sensorData.filter(function(s){return s.area===area&&s.line===line&&s.sensorType===type}).map(function(s){return s.sensorTypeDetail}).filter(Boolean));
  sel.innerHTML='<option value="">-- select --</option>';
  details.forEach(function(d){sel.innerHTML+='<option value="'+esc(d)+'">'+esc(d)+'</option>';});
  if(details.length===1) sel.value=details[0];
  document.getElementById('coilRow').style.display=['Hx','Hy','Hz'].indexOf(type)!==-1?'':'none';
  onDetailChange();
}
function onDetailChange() { refreshCodeDropdown(); }

function refreshCodeDropdown() {
  var area=document.getElementById('selArea').value, line=document.getElementById('selLine').value;
  var type=document.getElementById('selType').value, detail=document.getElementById('selDetail').value;
  var sel=document.getElementById('selCode'), curVal=sel.value;
  var matching=sensorData.filter(function(s){return s.area===area&&s.line===line&&s.sensorType===type&&s.sensorTypeDetail===detail;});
  matching=matching.map(function(s){return{s:s,dist:getSensorDistance(s)};});
  matching.sort(function(a,b){return a.dist-b.dist;});
  sel.innerHTML='<option value="">-- select --</option>';
  matching.forEach(function(item){
    var d=formatDist(item.dist), dl=d?' ('+d+')':'';
    sel.innerHTML+='<option value="'+esc(item.s.sensorCode)+'">'+esc(item.s.sensorCode)+dl+'</option>';
  });
  if(curVal&&matching.some(function(i){return i.s.sensorCode===curVal;})) sel.value=curVal;
  else if(matching.length===1) sel.value=matching[0].s.sensorCode;
  validateForm();
}

// ═══════════════════════════════════
// DURATION / VALIDATION
// ═══════════════════════════════════
function calcDuration() {
  var id=document.getElementById('inInstDate').value, it=document.getElementById('inInstTime').value;
  var pd=document.getElementById('inPickDate').value, pt=document.getElementById('inPickTime').value;
  var el=document.getElementById('inDuration');
  if(id&&it&&pd&&pt){var h=(new Date(pd+'T'+pt)-new Date(id+'T'+it))/3600000;el.value=h.toFixed(2);el.className=h<0?'duration-bad':'duration-ok';}
  else{el.value='';el.className='';}
}
function validateForm() {
  var v=document.getElementById('selArea').value&&document.getElementById('selLine').value
    &&document.getElementById('selType').value&&document.getElementById('selDetail').value
    &&document.getElementById('selCode').value&&document.getElementById('inGdas').value
    &&document.getElementById('selChannel').value&&document.getElementById('inInstDate').value
    &&document.getElementById('inInstTime').value;
  var type=document.getElementById('selType').value;
  if(['Hx','Hy','Hz'].indexOf(type)!==-1&&!document.getElementById('inCoil').value) v=false;
  document.getElementById('btnSubmit').disabled=!v;
}

// ═══════════════════════════════════
// SUBMIT / EDIT / DELETE
// ═══════════════════════════════════
function submitLog() {
  var log={
    area:document.getElementById('selArea').value, line:document.getElementById('selLine').value,
    sensorType:document.getElementById('selType').value, sensorTypeDetail:document.getElementById('selDetail').value,
    sensorCode:document.getElementById('selCode').value, gDAS:document.getElementById('inGdas').value,
    channel:document.getElementById('selChannel').value, coilNumber:document.getElementById('inCoil').value,
    installDate:document.getElementById('inInstDate').value, installTime:document.getElementById('inInstTime').value,
    pickupDate:document.getElementById('inPickDate').value, pickupTime:document.getElementById('inPickTime').value,
    duration:document.getElementById('inDuration').value, comments:document.getElementById('inComments').value,
    timestamp:new Date().toISOString(), gpsLat:userLat, gpsLon:userLon, gpsAcc:gpsAccuracy
  };
  if(editingIndex!==null){logs[editingIndex]=log;editingIndex=null;document.getElementById('editBtns').style.display='none';toast('Log updated');}
  else{
    var dup=-1;for(var i=0;i<logs.length;i++){if(logs[i].sensorCode===log.sensorCode&&logs[i].installDate===log.installDate&&logs[i].installTime===log.installTime){dup=i;break;}}
    if(dup!==-1){if(confirm('Duplicate sensor+time. Overwrite?'))logs[dup]=log;else logs.push(log);}
    else logs.push(log);
    toast('Log saved');
  }
  saveLogs(); updateLogCount(); clearFormPartial();
}
function loadLogForEdit(idx) {
  var log=logs[idx];
  document.getElementById('selArea').value=log.area; onAreaChange();
  document.getElementById('selLine').value=log.line; onLineChange();
  document.getElementById('selType').value=log.sensorType; onTypeChange();
  document.getElementById('selDetail').value=log.sensorTypeDetail; onDetailChange();
  setTimeout(function(){
    var sel=document.getElementById('selCode');
    for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===log.sensorCode){sel.selectedIndex=i;break;}}
    document.getElementById('inGdas').value=log.gDAS;
    document.getElementById('selChannel').value=log.channel;
    document.getElementById('inCoil').value=log.coilNumber||'';
    document.getElementById('inInstDate').value=log.installDate;
    document.getElementById('inInstTime').value=log.installTime;
    document.getElementById('inPickDate').value=log.pickupDate||'';
    document.getElementById('inPickTime').value=log.pickupTime||'';
    document.getElementById('inComments').value=log.comments||'';
    calcDuration(); editingIndex=idx;
    document.getElementById('editBtns').style.display='';
    document.getElementById('btnSubmit').textContent='Update Log';
    validateForm(); switchTab('form');
    window.scrollTo({top:0,behavior:'smooth'});
  },50);
}
function cancelEdit() {
  editingIndex=null; document.getElementById('editBtns').style.display='none';
  document.getElementById('btnSubmit').textContent='Submit Log'; clearFormPartial();
}
function deleteLog(idx) {
  if(!confirm('Delete this log?')) return;
  logs.splice(idx,1); saveLogs(); updateLogCount(); renderLogs();
  if(editingIndex===idx) cancelEdit(); toast('Log deleted');
}
function clearFormPartial() {
  document.getElementById('selCode').value=''; document.getElementById('inGdas').value='';
  document.getElementById('selChannel').value=''; document.getElementById('inCoil').value='';
  document.getElementById('inPickDate').value=''; document.getElementById('inPickTime').value='';
  document.getElementById('inComments').value=''; document.getElementById('inDuration').value='';
  var now=new Date();
  document.getElementById('inInstDate').value=now.toISOString().split('T')[0];
  document.getElementById('inInstTime').value=now.toTimeString().slice(0,5);
  document.getElementById('btnSubmit').textContent='Submit Log'; validateForm();
}

// ═══════════════════════════════════
// LOG RENDERING
// ═══════════════════════════════════
function renderLogs() {
  var el=document.getElementById('logsList');
  if(!logs.length){el.innerHTML='<div class="empty"><div class="icon">&#x1F4CB;</div>No logs yet.</div>';return;}
  var html='';
  for(var ri=logs.length-1;ri>=0;ri--){
    var log=logs[ri], ed=ri===editingIndex;
    var from=log.installDate+' '+log.installTime;
    var to=(log.pickupDate&&log.pickupTime)?log.pickupDate+' '+log.pickupTime:'--';
    html+='<div class="log-card '+(ed?'editing':'')+'" onclick="loadLogForEdit('+ri+')">'
      +'<div class="log-header"><span class="log-title">'+esc(log.sensorCode)+' -- Ch'+esc(log.channel)+'</span>'
      +'<span style="font-size:11px;color:var(--text2)">gDAS '+esc(log.gDAS)+'</span></div>'
      +'<div class="log-meta">'+esc(log.area)+' / '+esc(log.line)+' / '+esc(log.sensorType)+' '+esc(log.sensorTypeDetail)+'<br>'
      +'Install: '+esc(from)+' &rarr; Pickup: '+esc(to)+(log.duration?' ('+esc(log.duration)+'h)':'')+'<br>'
      +(log.comments?'<em>'+esc(log.comments)+'</em>':'')+(log.coilNumber?' Coil: '+esc(log.coilNumber):'')
      +'</div><div class="log-actions">'
      +'<button class="btn btn-red btn-sm" onclick="event.stopPropagation();deleteLog('+ri+')">Delete</button>'
      +'</div></div>';
  }
  el.innerHTML=html;
}

// ═══════════════════════════════════
// FILE IMPORT / EXPORT
// ═══════════════════════════════════
function handleFileImport(evt) {
  var file=evt.target.files[0]; if(!file) return;
  var status=document.getElementById('importStatus'); status.textContent='Reading...';
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var wb=XLSX.read(e.target.result,{type:'binary'}), ws=wb.Sheets[wb.SheetNames[0]];
      var json=XLSX.utils.sheet_to_json(ws);
      if(!json.length){status.textContent='No data found';return;}
      sensorData=json; localStorage.setItem('sensorData',JSON.stringify(sensorData));
      populateAreas(); updateDataStats();
      status.textContent='Imported '+json.length+' sensors'; toast(json.length+' sensors loaded');
    }catch(err){status.textContent='Error: '+err.message;}
  };
  reader.readAsBinaryString(file);
}
function exportXLSX() {
  if(!logs.length){toast('No logs');return;}
  var d=logs.map(function(l){return{Area:l.area,Line:l.line,SensorType:l.sensorType,SensorTypeDetail:l.sensorTypeDetail,
    SensorCode:l.sensorCode,gDAS_SN:l.gDAS,Channel:l.channel,CoilSN:l.coilNumber||'',
    InstallDate:l.installDate,InstallTime:l.installTime,PickupDate:l.pickupDate||'',PickupTime:l.pickupTime||'',
    Duration_hrs:l.duration||'',Comments:l.comments||'',GPS_Lat:l.gpsLat||'',GPS_Lon:l.gpsLon||'',
    GPS_Acc_m:l.gpsAcc?Math.round(l.gpsAcc):'',Timestamp:l.timestamp};});
  var ws=XLSX.utils.json_to_sheet(d), wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'SurveyLogs');
  XLSX.writeFile(wb,'gDAS_Survey_'+new Date().toISOString().slice(0,10).replace(/-/g,'')+'.xlsx');
  toast('Excel exported');
}
function exportCSV() {
  if(!logs.length){toast('No logs');return;}
  var h=['Area','Line','SensorType','SensorTypeDetail','SensorCode','gDAS_SN','Channel','CoilSN',
    'InstallDate','InstallTime','PickupDate','PickupTime','Duration_hrs','Comments','GPS_Lat','GPS_Lon','GPS_Acc_m','Timestamp'];
  var rows=logs.map(function(l){return[l.area,l.line,l.sensorType,l.sensorTypeDetail,l.sensorCode,
    l.gDAS,l.channel,l.coilNumber||'',l.installDate,l.installTime,l.pickupDate||'',l.pickupTime||'',
    l.duration||'','"'+(l.comments||'').replace(/"/g,'""')+'"',l.gpsLat||'',l.gpsLon||'',
    l.gpsAcc?Math.round(l.gpsAcc):'',l.timestamp];});
  var csv=[h.join(',')].concat(rows.map(function(r){return r.join(',')})).join('\n');
  var blob=new Blob([csv],{type:'text/csv'}), a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='gDAS_Survey_'+new Date().toISOString().slice(0,10).replace(/-/g,'')+'.csv'; a.click();
  toast('CSV exported');
}

// ═══════════════════════════════════
// DATA MANAGEMENT
// ═══════════════════════════════════
function clearAllLogs(){if(!confirm('Delete ALL logs?'))return;logs=[];saveLogs();updateLogCount();renderLogs();toast('All logs cleared');}
function clearSensorData(){if(!confirm('Clear sensor plan?'))return;sensorData=[];localStorage.removeItem('sensorData');populateAreas();updateDataStats();toast('Sensor plan cleared');}
function saveLogs(){localStorage.setItem('sensorLogs',JSON.stringify(logs));}
function saveDatumZone(){
  localStorage.setItem('selectedDatum',document.getElementById('mapDatum').value);
  localStorage.setItem('utmZone',document.getElementById('mapZone').value);
  refreshCodeDropdown();
}
function updateLogCount(){document.getElementById('logCount').textContent=logs.length;}
function updateDataStats(){document.getElementById('dataStats').textContent=sensorData.length+' sensors loaded, '+logs.length+' logs saved';}

// ═══════════════════════════════════
// TABS
// ═══════════════════════════════════
function switchTab(name) {
  document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.tabbar button').forEach(function(b){b.classList.remove('active');});
  document.getElementById('tab-'+name).classList.add('active');
  var btns=document.querySelectorAll('.tabbar button');
  if(name==='form')btns[0].classList.add('active');
  if(name==='map')btns[1].classList.add('active');
  if(name==='logs')btns[2].classList.add('active');
  if(name==='settings')btns[3].classList.add('active');
  if(name==='logs') renderLogs();
  if(name==='settings') updateDataStats();
  if(name==='map') setTimeout(function(){initMap();leafletMap.invalidateSize();},100);
}

// ═══════════════════════════════════
// UTILS
// ═══════════════════════════════════
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function unique(arr){var seen={},r=[];arr.forEach(function(v){if(!seen[v]){seen[v]=true;r.push(v);}});return r.sort();}
function toast(msg){var el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2000);}
</script>
</body>
</html>
