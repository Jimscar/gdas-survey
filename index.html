<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1d23">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>gDAS Survey</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#1a1d23; --surface:#23272f; --surface2:#2a2f38; --border:#3a3f4a;
  --text:#e8eaed; --text2:#9aa0a8; --accent:#4da6ff; --green:#34c759;
  --red:#ff453a; --orange:#ff9f0a; --radius:8px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);font-size:14px;min-height:100vh;}
.topbar{position:sticky;top:0;z-index:1000;background:var(--surface);border-bottom:1px solid var(--border);padding:8px 12px;display:flex;align-items:center;justify-content:space-between;}
.topbar h1{font-size:16px;font-weight:700;color:var(--accent);letter-spacing:.5px;}
.topbar .status{font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px;}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;}.dot-on{background:var(--green);}.dot-off{background:var(--red);}
.tabbar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:37px;z-index:999;}
.tabbar button{flex:1;padding:10px 0;background:none;border:none;color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;}
.tabbar button.active{color:var(--accent);border-bottom-color:var(--accent);}
.panel{display:none;padding:12px;max-width:600px;margin:0 auto;}.panel.active{display:block;}
#tab-map.active{display:block;max-width:none;padding:0;}
.section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;}
.section h3{font-size:12px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:700;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-grid .full{grid-column:1/-1;}
label{display:block;font-size:11px;color:var(--text2);margin-bottom:4px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
select,input[type="text"],input[type="number"],input[type="date"],input[type="time"],textarea{width:100%;padding:9px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;font-family:inherit;outline:none;}
select:focus,input:focus,textarea:focus{border-color:var(--accent);}
textarea{resize:vertical;min-height:60px;}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239aa0a8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:30px;}
input[type="file"]::file-selector-button{background:var(--accent);color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;margin-right:10px;}
.duration-ok{color:var(--green);}.duration-bad{color:var(--red);font-weight:700;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 16px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit;}
.btn-primary{background:var(--accent);color:#fff;}.btn-primary:disabled{background:var(--border);color:var(--text2);cursor:not-allowed;}
.btn-green{background:var(--green);color:#fff;}.btn-red{background:var(--red);color:#fff;}.btn-orange{background:var(--orange);color:#1a1d23;}
.btn-ghost{background:var(--surface2);color:var(--text);}
.btn-sm{padding:5px 10px;font-size:12px;}.btn-full{width:100%;}.btn-row{display:flex;gap:8px;margin-top:10px;}
.log-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:border-color .2s;}
.log-card:hover{border-color:var(--accent);}.log-card.editing{border-color:var(--green);background:#1e2a1e;}
.log-card .log-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.log-card .log-title{font-weight:700;font-size:14px;}.log-card .log-meta{font-size:12px;color:var(--text2);line-height:1.6;}
.log-card .log-actions{display:flex;gap:6px;margin-top:6px;}
.gps-bar{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;margin-bottom:12px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px;}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);padding:10px 20px;border-radius:8px;font-size:13px;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}.toast.show{opacity:1;}
.empty{text-align:center;padding:40px 20px;color:var(--text2);}.empty .icon{font-size:32px;margin-bottom:8px;}
.badge{background:var(--accent);color:#fff;border-radius:10px;padding:1px 7px;font-size:11px;font-weight:700;margin-left:6px;}

/* Toggle */
.toggle-row{display:flex;gap:0;margin-bottom:12px;border-radius:6px;overflow:hidden;border:1px solid var(--border);}
.toggle-row button{flex:1;padding:10px;background:var(--surface2);border:none;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.toggle-row button.active{background:var(--accent);color:#fff;}

/* Map */
#mapContainer{width:100%;height:calc(100vh - 95px);}
.map-toolbar{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:12px;}
.map-toolbar select,.map-toolbar input[type="text"]{padding:5px 8px;font-size:12px;width:auto;min-width:0;}
.map-toolbar input[type="text"]{width:55px;}
.map-toolbar label{margin:0;font-size:11px;display:inline-flex;align-items:center;gap:4px;}
.pulse-marker{width:20px;height:20px;background:lime;border-radius:50%;border:3px solid white;-webkit-animation:pulse 2s infinite;animation:pulse 2s infinite;}
@-webkit-keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,255,0,0.7);}70%{box-shadow:0 0 0 15px rgba(0,255,0,0);}100%{box-shadow:0 0 0 0 rgba(0,255,0,0);}}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,255,0,0.7);}70%{box-shadow:0 0 0 15px rgba(0,255,0,0);}100%{box-shadow:0 0 0 0 rgba(0,255,0,0);}}
.leaflet-popup-content-wrapper{background:var(--surface);color:var(--text);border-radius:8px;}
.leaflet-popup-tip{background:var(--surface);}.leaflet-popup-content{font-size:12px;line-height:1.6;}
@media(max-width:400px){.form-grid{grid-template-columns:1fr;}.form-grid .full{grid-column:1;}}
</style>
</head>
<body>
<div class="topbar"><h1>gDAS Survey</h1><div class="status"><span class="dot" id="gpsDot"></span><span id="gpsText">GPS...</span></div></div>
<div class="tabbar">
  <button class="active" onclick="switchTab('form')">Log Entry</button>
  <button onclick="switchTab('map')">Map</button>
  <button onclick="switchTab('logs')">Logs <span class="badge" id="logCount">0</span></button>
  <button onclick="switchTab('settings')">Settings</button>
</div>

<!-- ═══ FORM TAB ═══ -->
<div class="panel active" id="tab-form">
  <div class="gps-bar"><span style="font-size:16px">&#x1F4E1;</span><span id="gpsInfo">Waiting for GPS fix...</span></div>

  <div class="toggle-row">
    <button class="active" id="btnRx" onclick="setLogType('rx')">Receiver</button>
    <button id="btnTx" onclick="setLogType('tx')">Transmitter</button>
  </div>

  <div class="section">
    <h3>Sensor Selection</h3>
    <div class="form-grid">
      <div><label>Area</label><select id="selArea" onchange="onAreaChange()"><option value="">--</option></select></div>
      <div><label>Line</label><select id="selLine" onchange="onLineChange()"><option value="">--</option></select></div>
      <div><label>Station</label><select id="selStation" onchange="onStationChange()"><option value="">--</option></select></div>
      <div><label>Type</label><select id="selType" onchange="onTypeChange()"><option value="">--</option></select></div>
      <div class="full"><label>Detail</label><select id="selDetail" onchange="onDetailChange()"><option value="">--</option></select></div>
      <div class="full"><label id="lblCode">Sensor Code</label><select id="selCode"><option value="">--</option></select></div>
    </div>
  </div>

  <div class="section">
    <h3>Deployment Info</h3>
    <div class="form-grid">
      <div><label>gDAS S/N</label><input type="number" id="inGdas" placeholder="e.g. 189"></div>
      <div><label>Channel</label><select id="selChannel"><option value="">--</option><option value="1">1</option><option value="2">2</option></select></div>
      <div class="full" id="coilRow" style="display:none"><label>Coil S/N</label><input type="text" id="inCoil" placeholder="Coil serial number"></div>
      <div class="full" id="refCurrentRow" style="display:none"><label>Ref Current (A)</label><input type="number" id="inRefCurrent" placeholder="e.g. 3" step="0.1"></div>
    </div>
  </div>

  <div class="section">
    <h3>Timing</h3>
    <div class="form-grid">
      <div><label>From Date</label><input type="date" id="inInstDate"></div>
      <div><label>From Time</label><input type="time" id="inInstTime"></div>
      <div><label>To Date</label><input type="date" id="inPickDate"></div>
      <div><label>To Time</label><input type="time" id="inPickTime"></div>
      <div class="full"><label>Duration (hours)</label><input type="text" id="inDuration" readonly placeholder="Auto-calculated"></div>
    </div>
  </div>

  <div class="section"><h3>Comments</h3><textarea id="inComments" placeholder="Any notes..."></textarea></div>

  <div class="btn-row"><button class="btn btn-primary btn-full" id="btnSubmit" onclick="submitLog()" disabled>Submit Log</button></div>
  <div class="btn-row" id="editBtns" style="display:none"><button class="btn btn-orange btn-full" onclick="cancelEdit()">Cancel Edit / New</button></div>
</div>

<!-- ═══ MAP TAB ═══ -->
<div class="panel" id="tab-map">
  <div class="map-toolbar">
    <label>Datum <select id="mapDatum" onchange="saveDatumZone()"><option value="">--</option><option value="WGS84">WGS84</option><option value="GDA94">GDA94</option><option value="PSAD56">PSAD56</option><option value="NAD83">NAD83</option></select></label>
    <label>Zone <input type="text" id="mapZone" placeholder="19S" oninput="saveDatumZone()"></label>
    <button class="btn btn-primary btn-sm" onclick="plotSensors()">Plot</button>
    <button class="btn btn-ghost btn-sm" onclick="clearMap()">Clear</button>
    <button class="btn btn-ghost btn-sm" onclick="resetMapView()">Reset</button>
    <label style="cursor:pointer"><input type="checkbox" id="chkLabels" checked onchange="plotSensors()"> Labels</label>
    <span style="border-left:1px solid var(--border);height:20px;margin:0 2px"></span>
    <button class="btn btn-primary btn-sm" id="mapFiltAll" onclick="setMapFilter('all')">All</button>
    <button class="btn btn-ghost btn-sm" id="mapFiltRx" onclick="setMapFilter('rx')">Rx</button>
    <button class="btn btn-ghost btn-sm" id="mapFiltTx" onclick="setMapFilter('tx')">Tx</button>
    <span style="border-left:1px solid var(--border);height:20px;margin:0 2px"></span>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('progressFileInput').click()">Import .xlsx</button>
    <input type="file" id="progressFileInput" accept=".xlsx,.xls" style="display:none" onchange="handleProgressImport(event)">
  </div>
  <div id="mapContainer"></div>
</div>

<!-- ═══ LOGS TAB ═══ -->
<div class="panel" id="tab-logs">
  <div class="toggle-row" style="margin-bottom:8px;">
    <button class="active" id="btnShowRx" onclick="setLogFilter('rx')">Receivers</button>
    <button id="btnShowTx" onclick="setLogFilter('tx')">Transmitters</button>
    <button id="btnShowAll" onclick="setLogFilter('all')">All</button>
  </div>
  <div id="logsList"></div>
</div>

<!-- ═══ SETTINGS TAB ═══ -->
<div class="panel" id="tab-settings">
  <div class="section">
    <h3>Operator</h3>
    <div class="form-grid">
      <div class="full"><label>Operator ID (initials or crew code)</label><input type="text" id="inOperator" placeholder="e.g. JS, Crew1" maxlength="10" oninput="saveOperator()"></div>
    </div>
  </div>

  <div class="section">
    <h3>Import Survey Info</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:10px">Load your _Survey_Info.xlsx (sensorInfo + sourceInfo sheets)</p>
    <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileImport(event)">
    <div id="importStatus" style="margin-top:8px;font-size:12px;color:var(--text2)"></div>
  </div>
  <div class="section">
    <h3>Export Installations</h3>
    <div id="exportFilename" style="font-size:12px;color:var(--text2);margin-bottom:8px;word-break:break-all;"></div>
    <div id="exportWarning" style="font-size:12px;color:var(--orange);margin-bottom:8px;"></div>
    <div class="btn-row"><button class="btn btn-green btn-full" onclick="exportAppend()">Append to existing .xlsx</button></div>
    <div class="btn-row"><button class="btn btn-primary btn-full" onclick="exportInstallations()">New .xlsx (overwrite)</button></div>
    <input type="file" id="appendFileInput" accept=".xlsx,.xls" style="display:none" onchange="handleAppendFile(event)">
    <div class="btn-row"><button class="btn btn-ghost btn-full" onclick="exportCSV()">Export as .csv</button></div>
  </div>
  <div class="section">
    <h3>Data Management</h3>
    <div class="btn-row"><button class="btn btn-red btn-full" onclick="clearAllLogs()">Clear All Logs</button></div>
    <div class="btn-row"><button class="btn btn-orange btn-full" onclick="clearSensorData()">Clear Survey Info</button></div>
    <div id="dataStats" style="margin-top:10px;font-size:12px;color:var(--text2)"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ═══════ STATE ═══════
var rxData=[], txData=[], logs=[], editingIndex=null;
var userLat=null, userLon=null, gpsAccuracy=null;
var leafletMap=null, sensorMarkers=[], userMarker=null;
var logType='rx'; // 'rx' or 'tx'
var logFilter='rx';
var mapFilter='all'; // 'all', 'rx', 'tx'
var importedProgress={}; // codes from imported xlsx marked as done

// ═══════ INIT ═══════
(function init(){
  try{rxData=JSON.parse(localStorage.getItem('rxData'))||[];}catch(e){rxData=[];}
  try{txData=JSON.parse(localStorage.getItem('txData'))||[];}catch(e){txData=[];}
  try{logs=JSON.parse(localStorage.getItem('sensorLogs'))||[];}catch(e){logs=[];}
  try{importedProgress=JSON.parse(localStorage.getItem('importedProgress'))||{};}catch(e){importedProgress={};}
  var d=localStorage.getItem('selectedDatum'),z=localStorage.getItem('utmZone');
  if(d)document.getElementById('mapDatum').value=d;
  if(z)document.getElementById('mapZone').value=z;
  var op=localStorage.getItem('operatorId')||'';
  if(op)document.getElementById('inOperator').value=op;
  var now=new Date();
  document.getElementById('inInstDate').value=now.toISOString().split('T')[0];
  document.getElementById('inInstTime').value=now.toTimeString().slice(0,5);
  populateAreas(); updateLogCount(); updateDataStats();
  ['inInstDate','inInstTime','inPickDate','inPickTime'].forEach(function(id){
    document.getElementById(id).addEventListener('input',calcDuration);
  });
  document.querySelectorAll('#tab-form select,#tab-form input,#tab-form textarea').forEach(function(el){
    el.addEventListener('input',validateForm);el.addEventListener('change',validateForm);
  });
  startGPS();
  if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js').catch(function(){});}
})();

// ═══════ LOG TYPE TOGGLE ═══════
function setLogType(t){
  logType=t;
  document.getElementById('btnRx').className=t==='rx'?'active':'';
  document.getElementById('btnTx').className=t==='tx'?'active':'';
  document.getElementById('lblCode').textContent=t==='rx'?'Sensor Code':'Source Code';
  document.getElementById('coilRow').style.display='none';
  document.getElementById('refCurrentRow').style.display=t==='tx'?'':'none';
  populateAreas(); clearFormPartial();
}

function setLogFilter(f){
  logFilter=f;
  document.getElementById('btnShowRx').className=f==='rx'?'active':'';
  document.getElementById('btnShowTx').className=f==='tx'?'active':'';
  document.getElementById('btnShowAll').className=f==='all'?'active':'';
  renderLogs();
}

function currentData(){return logType==='rx'?rxData:txData;}

// ═══════ GPS ═══════
function startGPS(){
  if(!navigator.geolocation){setGPSStatus(false,'GPS not available');return;}
  navigator.geolocation.watchPosition(function(pos){
    userLat=pos.coords.latitude;userLon=pos.coords.longitude;gpsAccuracy=pos.coords.accuracy;
    setGPSStatus(true,userLat.toFixed(5)+', '+userLon.toFixed(5)+' (+-'+Math.round(gpsAccuracy)+'m)');
    refreshCodeDropdown(); updateUserMarker();
  },function(err){setGPSStatus(false,'No GPS fix ('+err.message+')');},
  {enableHighAccuracy:true,maximumAge:10000,timeout:15000});
}
function setGPSStatus(ok,text){
  document.getElementById('gpsDot').className='dot '+(ok?'dot-on':'dot-off');
  document.getElementById('gpsText').textContent=ok?'GPS':'No GPS';
  document.getElementById('gpsInfo').textContent=text;
}

// ═══════ UTM ═══════
function utmToLatLon(e,n,zs){
  if(!zs)return null;var m=zs.match(/(\d+)\s*([NSns]?)/);if(!m)return null;
  var zone=parseInt(m[1]),south=(m[2]||'').toUpperCase()==='S';
  var a=6378137,f=1/298.257223563,k0=.9996,ee=Math.sqrt(2*f-f*f),e2=ee*ee,ep2=e2/(1-e2);
  var x=e-500000,y=south?n-10000000:n,M=y/k0;
  var mu=M/(a*(1-e2/4-3*e2*e2/64-5*e2*e2*e2/256));
  var e1=(1-Math.sqrt(1-e2))/(1+Math.sqrt(1-e2));
  var phi1=mu+(3*e1/2-27*e1*e1*e1/32)*Math.sin(2*mu)+(21*e1*e1/16-55*e1*e1*e1*e1/32)*Math.sin(4*mu)+(151*e1*e1*e1/96)*Math.sin(6*mu);
  var sp=Math.sin(phi1),cp=Math.cos(phi1),tp=Math.tan(phi1);
  var C1=ep2*cp*cp,T1=tp*tp,N1=a/Math.sqrt(1-e2*sp*sp),R1=a*(1-e2)/Math.pow(1-e2*sp*sp,1.5),D=x/(N1*k0);
  var lat=phi1-(N1*tp/R1)*(D*D/2-(5+3*T1+10*C1-4*C1*C1-9*ep2)*D*D*D*D/24+(61+90*T1+298*C1+45*T1*T1-252*ep2-3*C1*C1)*D*D*D*D*D*D/720);
  var lon=(D-(1+2*T1+C1)*D*D*D/6+(5-2*C1+28*T1-3*C1*C1+8*ep2+24*T1*T1)*D*D*D*D*D/120)/cp;
  var lon0=((zone-1)*6-180+3)*Math.PI/180;
  return{lat:lat*180/Math.PI,lon:(lon+lon0)*180/Math.PI};
}
function distanceKm(a1,o1,a2,o2){var R=6371,dL=(a2-a1)*Math.PI/180,dO=(o2-o1)*Math.PI/180;var a=Math.sin(dL/2)*Math.sin(dL/2)+Math.cos(a1*Math.PI/180)*Math.cos(a2*Math.PI/180)*Math.sin(dO/2)*Math.sin(dO/2);return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function getSensorDistance(s){
  if(userLat===null||!s.UTMx||!s.UTMy)return Infinity;
  var z=document.getElementById('mapZone').value;if(!z)return Infinity;
  var ll=utmToLatLon(parseFloat(s.UTMx),parseFloat(s.UTMy),z);
  return ll?distanceKm(userLat,userLon,ll.lat,ll.lon):Infinity;
}
function formatDist(km){if(!isFinite(km))return'';return km<1?Math.round(km*1000)+'m':km.toFixed(1)+'km';}

// ═══════ CASCADING DROPDOWNS ═══════
function populateAreas(){
  var sel=document.getElementById('selArea'),cur=sel.value;
  var data=currentData();
  var areas=unique(data.map(function(s){return s.area}).filter(Boolean));
  sel.innerHTML='<option value="">--</option>';
  areas.forEach(function(a){sel.innerHTML+='<option value="'+esc(a)+'">'+esc(a)+'</option>';});
  sel.value=cur; onAreaChange();
}
function onAreaChange(){
  var area=v('selArea'),sel=document.getElementById('selLine'),data=currentData();
  var lines=unique(data.filter(function(s){return s.area===area}).map(function(s){return s.line}).filter(Boolean));
  sel.innerHTML='<option value="">--</option>';
  lines.forEach(function(l){sel.innerHTML+='<option value="'+esc(l)+'">'+esc(l)+'</option>';});
  if(lines.length===1)sel.value=lines[0];
  onLineChange();
}
function onLineChange(){
  var area=v('selArea'),line=v('selLine'),sel=document.getElementById('selStation'),data=currentData();
  var stations=unique(data.filter(function(s){return s.area===area&&s.line===line}).map(function(s){return String(s.station)}).filter(Boolean));
  // Sort numerically if possible
  stations.sort(function(a,b){var na=parseFloat(a),nb=parseFloat(b);if(!isNaN(na)&&!isNaN(nb))return na-nb;return a.localeCompare(b);});
  sel.innerHTML='<option value="">--</option>';

  // Add distance to station options
  stations.forEach(function(st){
    var matching=data.filter(function(s){return s.area===area&&s.line===line&&String(s.station)===st;});
    var dist=Infinity;
    if(matching.length>0)dist=getSensorDistance(matching[0]);
    var dl=formatDist(dist);dl=dl?' ('+dl+')':'';
    sel.innerHTML+='<option value="'+esc(st)+'">'+esc(st)+dl+'</option>';
  });
  if(stations.length===1)sel.value=stations[0];
  onStationChange();
}
function onStationChange(){
  var area=v('selArea'),line=v('selLine'),station=v('selStation'),data=currentData();
  var sel=document.getElementById('selType');
  var typeField=logType==='rx'?'sensorType':'sourceType';
  var types=unique(data.filter(function(s){return s.area===area&&s.line===line&&String(s.station)===station}).map(function(s){return s[typeField]}).filter(Boolean));
  sel.innerHTML='<option value="">--</option>';
  types.forEach(function(t){sel.innerHTML+='<option value="'+esc(t)+'">'+esc(t)+'</option>';});
  if(types.length===1)sel.value=types[0];
  onTypeChange();
}
function onTypeChange(){
  var area=v('selArea'),line=v('selLine'),station=v('selStation'),type=v('selType'),data=currentData();
  var sel=document.getElementById('selDetail');
  var typeField=logType==='rx'?'sensorType':'sourceType';
  var detailField=logType==='rx'?'sensorTypeDetail':'sourceTypeDetail';
  var details=unique(data.filter(function(s){return s.area===area&&s.line===line&&String(s.station)===station&&s[typeField]===type}).map(function(s){return s[detailField]}).filter(Boolean));
  sel.innerHTML='<option value="">--</option>';
  details.forEach(function(d){sel.innerHTML+='<option value="'+esc(d)+'">'+esc(d)+'</option>';});
  if(details.length===1)sel.value=details[0];
  // Show coil row for H-type receivers
  var isH=logType==='rx'&&type&&(type.indexOf('Hx')===0||type.indexOf('Hy')===0||type.indexOf('Hz')===0);
  document.getElementById('coilRow').style.display=isH?'':'none';
  onDetailChange();
}
function onDetailChange(){refreshCodeDropdown();}

function refreshCodeDropdown(){
  var area=v('selArea'),line=v('selLine'),station=v('selStation'),type=v('selType'),detail=v('selDetail');
  var data=currentData(),sel=document.getElementById('selCode'),curVal=sel.value;
  var typeField=logType==='rx'?'sensorType':'sourceType';
  var detailField=logType==='rx'?'sensorTypeDetail':'sourceTypeDetail';
  var codeField=logType==='rx'?'sensorCode':'sourceCode';
  var matching=data.filter(function(s){return s.area===area&&s.line===line&&String(s.station)===station&&s[typeField]===type&&s[detailField]===detail;});
  matching=matching.map(function(s){return{s:s,dist:getSensorDistance(s)};});
  matching.sort(function(a,b){return a.dist-b.dist;});
  sel.innerHTML='<option value="">--</option>';
  matching.forEach(function(item){
    var code=item.s[codeField]||'';
    var dl=formatDist(item.dist);dl=dl?' ('+dl+')':'';
    sel.innerHTML+='<option value="'+esc(code)+'">'+esc(code)+dl+'</option>';
  });
  if(curVal&&matching.some(function(i){return(i.s[codeField]||'')===curVal;}))sel.value=curVal;
  else if(matching.length===1)sel.value=matching[0].s[codeField]||'';

  // Auto-fill coil from sensorSN if available
  if(logType==='rx'&&matching.length===1){
    var sn=matching[0].s.sensorSN;
    if(sn&&String(sn)!=='0')document.getElementById('inCoil').value=sn;
  }
  validateForm();
}

// ═══════ DURATION / VALIDATION ═══════
function calcDuration(){
  var id=v('inInstDate'),it=v('inInstTime'),pd=v('inPickDate'),pt=v('inPickTime'),el=document.getElementById('inDuration');
  if(id&&it&&pd&&pt){var h=(new Date(pd+'T'+pt)-new Date(id+'T'+it))/3600000;el.value=h.toFixed(2);el.className=h<0?'duration-bad':'duration-ok';}
  else{el.value='';el.className='';}
}
function validateForm(){
  var ok=v('selArea')&&v('selLine')&&v('selStation')&&v('selType')&&v('selDetail')&&v('selCode')&&v('inGdas')&&v('selChannel')&&v('inInstDate')&&v('inInstTime');
  var type=v('selType');
  if(logType==='rx'&&type&&(type.indexOf('Hx')===0||type.indexOf('Hy')===0||type.indexOf('Hz')===0)&&!v('inCoil'))ok=false;
  document.getElementById('btnSubmit').disabled=!ok;
}

// ═══════ SUBMIT / EDIT ═══════
function submitLog(){
  var codeField=logType==='rx'?'sensorCode':'sourceCode';
  var log={
    logType:logType,
    area:v('selArea'),line:v('selLine'),station:v('selStation'),
    sensorType:v('selType'),sensorTypeDetail:v('selDetail'),
    sensorCode:v('selCode'),
    gDAS:v('inGdas'),channel:v('selChannel'),
    coilNumber:v('inCoil'),refCurrent:v('inRefCurrent'),
    installDate:v('inInstDate'),installTime:v('inInstTime'),
    pickupDate:v('inPickDate'),pickupTime:v('inPickTime'),
    duration:v('inDuration'),comments:v('inComments'),
    timestamp:new Date().toISOString(),
    operator:(localStorage.getItem('operatorId')||'').trim(),
    gpsLat:userLat,gpsLon:userLon,gpsAcc:gpsAccuracy
  };
  if(editingIndex!==null){logs[editingIndex]=log;editingIndex=null;document.getElementById('editBtns').style.display='none';toast('Log updated');}
  else{
    var dup=-1;for(var i=0;i<logs.length;i++){if(logs[i].sensorCode===log.sensorCode&&logs[i].installDate===log.installDate&&logs[i].installTime===log.installTime){dup=i;break;}}
    if(dup!==-1){if(confirm('Duplicate entry. Overwrite?'))logs[dup]=log;else logs.push(log);}
    else logs.push(log);
    toast('Log saved');
  }
  saveLogs();updateLogCount();clearFormPartial();
}
function loadLogForEdit(idx){
  var log=logs[idx];
  setLogType(log.logType||'rx');
  document.getElementById('selArea').value=log.area;onAreaChange();
  setTimeout(function(){
    document.getElementById('selLine').value=log.line;onLineChange();
    setTimeout(function(){
      document.getElementById('selStation').value=log.station||'';onStationChange();
      setTimeout(function(){
        document.getElementById('selType').value=log.sensorType;onTypeChange();
        setTimeout(function(){
          document.getElementById('selDetail').value=log.sensorTypeDetail;onDetailChange();
          setTimeout(function(){
            var sel=document.getElementById('selCode');
            for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===log.sensorCode){sel.selectedIndex=i;break;}}
            document.getElementById('inGdas').value=log.gDAS;
            document.getElementById('selChannel').value=log.channel;
            document.getElementById('inCoil').value=log.coilNumber||'';
            document.getElementById('inRefCurrent').value=log.refCurrent||'';
            document.getElementById('inInstDate').value=log.installDate;
            document.getElementById('inInstTime').value=log.installTime;
            document.getElementById('inPickDate').value=log.pickupDate||'';
            document.getElementById('inPickTime').value=log.pickupTime||'';
            document.getElementById('inComments').value=log.comments||'';
            calcDuration();editingIndex=idx;
            document.getElementById('editBtns').style.display='';
            document.getElementById('btnSubmit').textContent='Update Log';
            validateForm();switchTab('form');window.scrollTo({top:0,behavior:'smooth'});
          },30);
        },30);
      },30);
    },30);
  },30);
}
function cancelEdit(){editingIndex=null;document.getElementById('editBtns').style.display='none';document.getElementById('btnSubmit').textContent='Submit Log';clearFormPartial();}
function deleteLog(idx){if(!confirm('Delete?'))return;logs.splice(idx,1);saveLogs();updateLogCount();renderLogs();if(editingIndex===idx)cancelEdit();toast('Deleted');}
function clearFormPartial(){
  document.getElementById('selCode').value='';document.getElementById('inGdas').value='';
  document.getElementById('selChannel').value='';document.getElementById('inCoil').value='';
  document.getElementById('inRefCurrent').value='';
  document.getElementById('inPickDate').value='';document.getElementById('inPickTime').value='';
  document.getElementById('inComments').value='';document.getElementById('inDuration').value='';
  var now=new Date();
  document.getElementById('inInstDate').value=now.toISOString().split('T')[0];
  document.getElementById('inInstTime').value=now.toTimeString().slice(0,5);
  document.getElementById('btnSubmit').textContent='Submit Log';validateForm();
}

// ═══════ LOGS ═══════
function renderLogs(){
  var el=document.getElementById('logsList');
  var filtered=logs.filter(function(l){if(logFilter==='all')return true;return(l.logType||'rx')===logFilter;});
  if(!filtered.length){el.innerHTML='<div class="empty"><div class="icon">&#x1F4CB;</div>No '+(logFilter==='all'?'':logFilter==='rx'?'receiver':'transmitter')+' logs yet.</div>';return;}
  var html='';
  for(var ri=filtered.length-1;ri>=0;ri--){
    var log=filtered[ri];var idx=logs.indexOf(log);var ed=idx===editingIndex;
    var from=log.installDate+' '+log.installTime;
    var to=(log.pickupDate&&log.pickupTime)?log.pickupDate+' '+log.pickupTime:'';
    var incomplete=!log.pickupDate||!log.pickupTime;
    var typeTag=(log.logType||'rx')==='tx'?'<span style="color:var(--orange)">TX</span> ':'';
    var incompTag=incomplete?'<span style="color:var(--orange);font-size:11px;margin-left:6px">&#9888; NO END TIME</span>':'';
    html+='<div class="log-card '+(ed?'editing':'')+'" style="'+(incomplete?'border-left:3px solid var(--orange);':'')+ '" onclick="loadLogForEdit('+idx+')">'
      +'<div class="log-header"><span class="log-title">'+typeTag+esc(log.sensorCode)+' -- Ch'+esc(log.channel)+incompTag+'</span>'
      +'<span style="font-size:11px;color:var(--text2)">gDAS '+esc(log.gDAS)+'</span></div>'
      +'<div class="log-meta">'+esc(log.area)+' / '+esc(log.line)+' / Stn '+esc(log.station)+' / '+esc(log.sensorType)+'<br>'
      +'From: '+esc(from)+' &rarr; To: '+(incomplete?'<span style="color:var(--orange)">pending</span>':esc(to))+(log.duration?' ('+esc(log.duration)+'h)':'')
      +(log.coilNumber?' | Coil: '+esc(log.coilNumber):'')
      +(log.refCurrent?' | Ref I: '+esc(log.refCurrent)+'A':'')
      +(log.comments?'<br><em>'+esc(log.comments)+'</em>':'')
      +'</div><div class="log-actions">'
      +'<button class="btn btn-red btn-sm" onclick="event.stopPropagation();deleteLog('+idx+')">Delete</button>'
      +'</div></div>';
  }
  el.innerHTML=html;
}

// ═══════ MAP ═══════
function initMap(){
  if(leafletMap)return;
  var sc=localStorage.getItem('mapCenter'),sz=localStorage.getItem('mapZoom');
  var center=sc?JSON.parse(sc):[-33.86,151.21];var zoom=sz?parseInt(sz):12;
  leafletMap=L.map('mapContainer').setView(center,zoom);
  var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM',maxZoom:19});
  var esri=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri',maxZoom:19});
  osm.addTo(leafletMap);L.control.layers({'OpenStreetMap':osm,'Esri Satellite':esri}).addTo(leafletMap);
  leafletMap.on('moveend',function(){var c=leafletMap.getCenter();localStorage.setItem('mapCenter',JSON.stringify([c.lat,c.lng]));localStorage.setItem('mapZoom',leafletMap.getZoom().toString());});
  updateUserMarker();
  if((rxData.length||txData.length)&&v('mapZone')&&v('mapDatum'))setTimeout(plotSensors,200);
}
function updateUserMarker(){
  if(!leafletMap||userLat===null)return;
  var icon=L.divIcon({html:'<div class="pulse-marker"></div>',iconSize:[20,20],iconAnchor:[10,10],className:''});
  if(userMarker){userMarker.setLatLng([userLat,userLon]);userMarker.setPopupContent('<strong>You</strong><br>'+userLat.toFixed(6)+', '+userLon.toFixed(6));}
  else{userMarker=L.marker([userLat,userLon],{icon:icon,zIndexOffset:1000}).bindPopup('<strong>You</strong><br>'+userLat.toFixed(6)+', '+userLon.toFixed(6)).addTo(leafletMap);}
}
function setMapFilter(f){
  mapFilter=f;
  document.getElementById('mapFiltAll').className='btn btn-sm '+(f==='all'?'btn-primary':'btn-ghost');
  document.getElementById('mapFiltRx').className='btn btn-sm '+(f==='rx'?'btn-primary':'btn-ghost');
  document.getElementById('mapFiltTx').className='btn btn-sm '+(f==='tx'?'btn-primary':'btn-ghost');
  plotSensors();
}
function plotSensors(){
  if(!leafletMap)return;
  var zone=v('mapZone'),datum=v('mapDatum');
  if(!zone||!datum){toast('Set datum & zone');return;}
  var showLabels=document.getElementById('chkLabels').checked;
  sensorMarkers.forEach(function(m){leafletMap.removeLayer(m);});sensorMarkers=[];
  try{logs=JSON.parse(localStorage.getItem('sensorLogs'))||[];}catch(e){logs=[];}
  var allData=[];
  if(mapFilter==='all'||mapFilter==='rx')allData=allData.concat(rxData);
  if(mapFilter==='all'||mapFilter==='tx')allData=allData.concat(txData);
  var grouped={};
  allData.forEach(function(sensor){
    if(!sensor.UTMx||!sensor.UTMy)return;
    var key=sensor.UTMx+','+sensor.UTMy;
    var ll=utmToLatLon(parseFloat(sensor.UTMx),parseFloat(sensor.UTMy),zone);if(!ll)return;
    var code=sensor.sensorCode||sensor.sourceCode||'';
    var matchingLog=null;
    for(var li=0;li<logs.length;li++){if(logs[li].sensorCode===code){matchingLog=logs[li];break;}}
    var hasComplete=matchingLog&&matchingLog.pickupDate&&matchingLog.pickupTime?true:false;
    var hasStart=matchingLog&&!hasComplete?true:false;
    // Also check imported progress
    if(!hasComplete&&importedProgress[code])hasComplete=true;
    if(!grouped[key])grouped[key]={lat:ll.lat,lon:ll.lon,sensors:[]};
    grouped[key].sensors.push({code:code,area:sensor.area,line:sensor.line,station:sensor.station,type:sensor.sensorType||sensor.sourceType||'',detail:sensor.sensorTypeDetail||sensor.sourceTypeDetail||'',hasComplete:hasComplete,hasStart:hasStart,isTx:!!sensor.sourceCode});
  });
  var groups=Object.values(grouped),bounds=[];
  groups.forEach(function(group){
    var hasAnyComplete=group.sensors.some(function(s){return s.hasComplete;});
    var hasAnyStart=group.sensors.some(function(s){return s.hasStart;});
    var allComplete=group.sensors.every(function(s){return s.hasComplete;});
    var col=allComplete?'#34c759':hasAnyComplete?'#8ae68a':hasAnyStart?'#ff9f0a':'#4da6ff';
    var sz=14;var labels='';
    if(showLabels){group.sensors.forEach(function(s,i){
      var b64=btoa(JSON.stringify(s));
      var lCol=s.hasComplete?'#34c759':s.hasStart?'#ff9f0a':'#222';
      labels+='<div onclick="event.stopPropagation();prefillFromMap(\''+b64+'\')" style="position:absolute;top:'+(-20-i*16)+'px;left:16px;font-size:13px;font-weight:bold;cursor:pointer;white-space:nowrap;color:'+lCol+';text-shadow:-1px -1px 0 #fff,1px -1px 0 #fff,-1px 1px 0 #fff,1px 1px 0 #fff,0 0 4px #fff;">'+esc(s.code)+'</div>';
    });}
    var html='<div style="position:relative;width:'+sz+'px;height:'+sz+'px;background:'+col+';border-radius:50%;border:2px solid white;">'+labels+'</div>';
    var icon=L.divIcon({html:html,iconSize:[sz+80,sz+40],iconAnchor:[sz/2,sz/2],className:''});
    var popup=group.sensors.map(function(s,i){
      var b64=btoa(JSON.stringify(s));
        var statusHtml=s.hasComplete?'<span style="color:#34c759">Complete</span>':s.hasStart?'<span style="color:#ff9f0a">Started</span>':'<span style="color:#ff453a">Not logged</span>';
      return '<strong>'+esc(s.area)+'/'+esc(s.line)+' Stn '+esc(s.station)+'</strong><br>'
        +esc(s.type)+': <strong>'+esc(s.code)+'</strong> '+statusHtml
        +'<br><a href="#" onclick="event.preventDefault();prefillFromMap(\''+b64+'\');" style="color:#4da6ff;text-decoration:underline;">Log this</a>'
        +(i<group.sensors.length-1?'<hr style="border-color:#3a3f4a;margin:4px 0">':'');
    }).join('');
    var marker=L.marker([group.lat,group.lon],{icon:icon}).bindPopup(popup).addTo(leafletMap);
    sensorMarkers.push(marker);bounds.push([group.lat,group.lon]);
  });
  if(bounds.length)leafletMap.fitBounds(bounds,{padding:[40,40],maxZoom:15});
  var label=mapFilter==='all'?'locations':mapFilter==='rx'?'Rx locations':'Tx locations';
  toast(groups.length+' '+label);
}
function clearMap(){sensorMarkers.forEach(function(m){leafletMap.removeLayer(m);});sensorMarkers=[];}
function resetMapView(){if(!sensorMarkers.length)return;var b=sensorMarkers.map(function(m){return m.getLatLng();});leafletMap.fitBounds(b,{padding:[40,40],maxZoom:15});}

function prefillFromMap(b64){
  try{
    var s=JSON.parse(atob(b64));
    setLogType(s.isTx?'tx':'rx');
    setTimeout(function(){
      document.getElementById('selArea').value=s.area||'';onAreaChange();
      setTimeout(function(){
        document.getElementById('selLine').value=s.line||'';onLineChange();
        setTimeout(function(){
          document.getElementById('selStation').value=String(s.station||'');onStationChange();
          setTimeout(function(){
            document.getElementById('selType').value=s.type||'';onTypeChange();
            setTimeout(function(){
              document.getElementById('selDetail').value=s.detail||'';onDetailChange();
              setTimeout(function(){
                var sel=document.getElementById('selCode');
                for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===s.code){sel.selectedIndex=i;break;}}
                validateForm();switchTab('form');
                window.scrollTo({top:0,behavior:'smooth'});
              },30);
            },30);
          },30);
        },30);
      },30);
    },30);
  }catch(e){console.error('prefill err',e);}
}

function handleProgressImport(evt){
  var file=evt.target.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var wb=XLSX.read(e.target.result,{type:'binary',cellDates:true});
      var count=0;
      // Read Receivers sheet - mark codes with both From and To as complete
      if(wb.SheetNames.indexOf('Receivers')!==-1){
        var rows=XLSX.utils.sheet_to_json(wb.Sheets['Receivers'],{raw:false});
        rows.forEach(function(r){
          var code=r.sensorCode||r.sourceCode||'';
          var hasTo=r.To&&String(r.To).trim();
          if(code&&hasTo){importedProgress[code]=true;count++;}
        });
      }
      // Read Transmitters sheet
      if(wb.SheetNames.indexOf('Transmitters')!==-1){
        var rows2=XLSX.utils.sheet_to_json(wb.Sheets['Transmitters'],{raw:false});
        rows2.forEach(function(r){
          var code=r.sourceCode||r.sensorCode||'';
          var hasTo=r.To&&String(r.To).trim();
          if(code&&hasTo){importedProgress[code]=true;count++;}
        });
      }
      localStorage.setItem('importedProgress',JSON.stringify(importedProgress));
      toast(count+' completed entries imported');
      plotSensors();
    }catch(err){toast('Error: '+err.message);}
  };
  reader.readAsBinaryString(file);
  evt.target.value='';
}

// ═══════ IMPORT ═══════
function handleFileImport(evt){
  var file=evt.target.files[0];if(!file)return;
  var status=document.getElementById('importStatus');status.textContent='Reading...';
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var wb=XLSX.read(e.target.result,{type:'binary'});
      var rxCount=0,txCount=0;
      // Read sensorInfo sheet
      if(wb.SheetNames.indexOf('sensorInfo')!==-1){
        var ws=wb.Sheets['sensorInfo'];
        rxData=XLSX.utils.sheet_to_json(ws);
        localStorage.setItem('rxData',JSON.stringify(rxData));
        rxCount=rxData.length;
      }
      // Read sourceInfo sheet
      if(wb.SheetNames.indexOf('sourceInfo')!==-1){
        var ws2=wb.Sheets['sourceInfo'];
        txData=XLSX.utils.sheet_to_json(ws2);
        localStorage.setItem('txData',JSON.stringify(txData));
        txCount=txData.length;
      }
      // Fallback: single sheet with area/line/sensorCode columns
      if(!rxCount&&!txCount){
        var ws3=wb.Sheets[wb.SheetNames[0]];
        var json=XLSX.utils.sheet_to_json(ws3);
        if(json.length){rxData=json;localStorage.setItem('rxData',JSON.stringify(rxData));rxCount=json.length;}
      }
      populateAreas();updateDataStats();
      status.textContent='Imported '+rxCount+' receivers, '+txCount+' sources';
      toast((rxCount+txCount)+' sensors loaded');
    }catch(err){status.textContent='Error: '+err.message;}
  };
  reader.readAsBinaryString(file);
}

// ═══════ EXPORT ═══════
function getProjectName(){
  // Find most common area string across rx+tx data, ignoring formulas and PMT
  var counts={};
  rxData.concat(txData).forEach(function(s){
    var a=String(s.area||'');
    if(!a||a.charAt(0)==='='||a==='PMT')return;
    counts[a]=(counts[a]||0)+1;
  });
  var best='',bestN=0;
  for(var k in counts){if(counts[k]>bestN){bestN=counts[k];best=k;}}
  return best||'Survey';
}

function getSurveySuffix(){
  var hasTx=txData.length>0;
  var hasCoils=rxData.some(function(s){
    var d=String(s.sensorTypeDetail||'').toLowerCase();
    return d.indexOf('induction coil')!==-1;
  });
  if(hasTx&&hasCoils)return'IP-MT';
  if(hasTx)return'IP';
  if(hasCoils)return'MT';
  return'MT'; // default
}

function getExportFilename(){
  var name=getProjectName();
  var suffix=getSurveySuffix();
  var op=(localStorage.getItem('operatorId')||'').trim();
  var fn=name+'_'+suffix+'_Installations';
  if(op)fn+='_'+op;
  return fn+'.xlsx';
}

function fmtDT(d,t){
  if(!d||!t)return'';
  var parts=d.split('-');
  return parts[2]+'/'+parts[1]+'/'+parts[0]+' '+t;
}

function exportInstallations(){
  if(!logs.length){toast('No logs');return;}

  // Split into complete (has end time) and incomplete
  var complete=[], incomplete=[];
  logs.forEach(function(l){
    if(l.pickupDate&&l.pickupTime) complete.push(l);
    else incomplete.push(l);
  });

  if(!complete.length){
    var msg='No logs ready to export.\n\n'+incomplete.length+' log(s) still need an end time:\n';
    incomplete.forEach(function(l){msg+='\n  • '+l.sensorCode+' (from '+l.installDate+' '+l.installTime+')';});
    alert(msg);
    return;
  }

  // Show warning about incomplete logs
  if(incomplete.length){
    var msg=complete.length+' log(s) will be exported.\n\n'+incomplete.length+' log(s) NOT included (no end time):\n';
    incomplete.forEach(function(l){msg+='\n  • '+l.sensorCode+' (from '+l.installDate+' '+l.installTime+')';});
    msg+='\n\nAdd end times on the Logs tab to include them.';
    alert(msg);
  }

  var wb=XLSX.utils.book_new();

  // Receivers sheet
  var rxLogs=complete.filter(function(l){return(l.logType||'rx')==='rx';});
  if(rxLogs.length){
    var rxRows=rxLogs.map(function(l){
      var row={
        'sensorCode':l.sensorCode,
        'gDAS s/n':parseInt(l.gDAS)||l.gDAS,
        'Channel':parseInt(l.channel)||l.channel,
        'From':fmtDT(l.installDate,l.installTime),
        'To':fmtDT(l.pickupDate,l.pickupTime),
        'Duration (Hrs)':l.duration?parseFloat(l.duration):''
      };
      if(l.coilNumber)row['Coil s/n']=l.coilNumber;
      return row;
    });
    var ws=XLSX.utils.json_to_sheet(rxRows);
    XLSX.utils.book_append_sheet(wb,ws,'Receivers');
  }

  // Transmitters sheet
  var txLogs=complete.filter(function(l){return l.logType==='tx';});
  if(txLogs.length){
    var txRows=txLogs.map(function(l){
      return{
        'sourceCode':l.sensorCode,
        'gDAS s/n':parseInt(l.gDAS)||l.gDAS,
        'channel':parseInt(l.channel)||l.channel,
        'From':fmtDT(l.installDate,l.installTime),
        'To':fmtDT(l.pickupDate,l.pickupTime),
        'Duration (hrs)':l.duration?parseFloat(l.duration):'',
        'Ref current':l.refCurrent?parseFloat(l.refCurrent):''
      };
    });
    var ws2=XLSX.utils.json_to_sheet(txRows);
    XLSX.utils.book_append_sheet(wb,ws2,'Transmitters');
  }

  if(!wb.SheetNames.length){toast('No complete logs');return;}
  XLSX.writeFile(wb,getExportFilename());
  toast(complete.length+' logs exported');
}

function exportAppend(){
  var complete=logs.filter(function(l){return l.pickupDate&&l.pickupTime;});
  if(!complete.length){
    var inc=logs.filter(function(l){return!l.pickupDate||!l.pickupTime;});
    alert('No logs ready to export.'+(inc.length?'\n\n'+inc.length+' log(s) still need an end time.':''));
    return;
  }
  document.getElementById('appendFileInput').click();
}

function handleAppendFile(evt){
  var file=evt.target.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var wb=XLSX.read(e.target.result,{type:'binary',cellDates:true});

      var complete=logs.filter(function(l){return l.pickupDate&&l.pickupTime;});
      var incomplete=logs.filter(function(l){return!l.pickupDate||!l.pickupTime;});
      var rxNew=complete.filter(function(l){return(l.logType||'rx')==='rx';});
      var txNew=complete.filter(function(l){return l.logType==='tx';});

      // Read existing Receivers sheet
      var existingRx=[];
      if(wb.SheetNames.indexOf('Receivers')!==-1){
        existingRx=XLSX.utils.sheet_to_json(wb.Sheets['Receivers'],{raw:false});
      }
      // Read existing Transmitters sheet
      var existingTx=[];
      if(wb.SheetNames.indexOf('Transmitters')!==-1){
        existingTx=XLSX.utils.sheet_to_json(wb.Sheets['Transmitters'],{raw:false});
      }

      // Build dedup keys from existing data (sensorCode + From)
      var rxKeys={};
      existingRx.forEach(function(r){rxKeys[(r.sensorCode||r.sourceCode||'')+'|'+(r.From||'')]=true;});
      var txKeys={};
      existingTx.forEach(function(r){txKeys[(r.sourceCode||r.sensorCode||'')+'|'+(r.From||'')]=true;});

      // Append new rows, skipping duplicates
      var rxAdded=0,txAdded=0,rxSkipped=0,txSkipped=0;

      rxNew.forEach(function(l){
        var fromStr=fmtDT(l.installDate,l.installTime);
        var key=l.sensorCode+'|'+fromStr;
        if(rxKeys[key]){rxSkipped++;return;}
        var row={'sensorCode':l.sensorCode,'gDAS s/n':parseInt(l.gDAS)||l.gDAS,'Channel':parseInt(l.channel)||l.channel,'From':fromStr,'To':fmtDT(l.pickupDate,l.pickupTime),'Duration (Hrs)':l.duration?parseFloat(l.duration):''};
        if(l.coilNumber)row['Coil s/n']=l.coilNumber;
        existingRx.push(row);rxAdded++;
      });

      txNew.forEach(function(l){
        var fromStr=fmtDT(l.installDate,l.installTime);
        var key=l.sensorCode+'|'+fromStr;
        if(txKeys[key]){txSkipped++;return;}
        existingTx.push({'sourceCode':l.sensorCode,'gDAS s/n':parseInt(l.gDAS)||l.gDAS,'channel':parseInt(l.channel)||l.channel,'From':fromStr,'To':fmtDT(l.pickupDate,l.pickupTime),'Duration (hrs)':l.duration?parseFloat(l.duration):'','Ref current':l.refCurrent?parseFloat(l.refCurrent):''});
        txAdded++;
      });

      // Rebuild workbook
      var wbOut=XLSX.utils.book_new();
      if(existingRx.length){
        var wsRx=XLSX.utils.json_to_sheet(existingRx);
        XLSX.utils.book_append_sheet(wbOut,wsRx,'Receivers');
      }
      if(existingTx.length){
        var wsTx=XLSX.utils.json_to_sheet(existingTx);
        XLSX.utils.book_append_sheet(wbOut,wsTx,'Transmitters');
      }

      XLSX.writeFile(wbOut,getExportFilename());

      var msg='Appended: '+rxAdded+' Rx, '+txAdded+' Tx.';
      if(rxSkipped||txSkipped)msg+='\nSkipped (already in file): '+rxSkipped+' Rx, '+txSkipped+' Tx.';
      if(incomplete.length)msg+='\n'+incomplete.length+' log(s) not included (no end time).';
      alert(msg);
      toast((rxAdded+txAdded)+' logs appended');
    }catch(err){alert('Error reading file: '+err.message);}
  };
  reader.readAsBinaryString(file);
  // Reset input so same file can be picked again
  evt.target.value='';
}

function exportCSV(){
  if(!logs.length){toast('No logs');return;}
  var complete=logs.filter(function(l){return l.pickupDate&&l.pickupTime;});
  var incomplete=logs.filter(function(l){return!l.pickupDate||!l.pickupTime;});
  if(!complete.length){alert('No logs ready — '+incomplete.length+' log(s) still need an end time.');return;}
  if(incomplete.length)alert(complete.length+' exported, '+incomplete.length+' skipped (no end time).');
  var h=['logType','sensorCode','gDAS_SN','Channel','From','To','Duration_hrs','CoilSN','RefCurrent','Comments','GPS_Lat','GPS_Lon'];
  var rows=complete.map(function(l){return[l.logType||'rx',l.sensorCode,l.gDAS,l.channel,fmtDT(l.installDate,l.installTime),fmtDT(l.pickupDate,l.pickupTime),l.duration||'',l.coilNumber||'',l.refCurrent||'','"'+(l.comments||'').replace(/"/g,'""')+'"',l.gpsLat||'',l.gpsLon||''];});
  var csv=[h.join(',')].concat(rows.map(function(r){return r.join(',')})).join('\n');
  var blob=new Blob([csv],{type:'text/csv'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  var name=getProjectName(),suffix=getSurveySuffix();
  var op=(localStorage.getItem('operatorId')||'').trim();
  var fn=name+'_'+suffix+'_Installations';if(op)fn+='_'+op;
  a.download=fn+'.csv';a.click();
  toast(complete.length+' logs exported');
}

// ═══════ DATA MANAGEMENT ═══════
function clearAllLogs(){if(!confirm('Delete ALL logs?'))return;logs=[];saveLogs();updateLogCount();renderLogs();toast('Cleared');}
function clearSensorData(){if(!confirm('Clear survey info?'))return;rxData=[];txData=[];importedProgress={};localStorage.removeItem('rxData');localStorage.removeItem('txData');localStorage.removeItem('importedProgress');populateAreas();updateDataStats();toast('Cleared');}
function saveLogs(){localStorage.setItem('sensorLogs',JSON.stringify(logs));}
function saveDatumZone(){localStorage.setItem('selectedDatum',v('mapDatum'));localStorage.setItem('utmZone',v('mapZone'));refreshCodeDropdown();}
function saveOperator(){localStorage.setItem('operatorId',v('inOperator').trim());}
function updateLogCount(){document.getElementById('logCount').textContent=logs.length;}
function updateDataStats(){var pCount=Object.keys(importedProgress).length;document.getElementById('dataStats').textContent=rxData.length+' receivers, '+txData.length+' sources, '+logs.length+' logs'+(pCount?', '+pCount+' imported as complete':'');}
function updateExportPreview(){
  var fn=document.getElementById('exportFilename');
  var warn=document.getElementById('exportWarning');
  if(!fn)return;
  fn.textContent='Filename: '+getExportFilename();
  var incomplete=logs.filter(function(l){return!l.pickupDate||!l.pickupTime;});
  if(incomplete.length){
    warn.textContent=incomplete.length+' log(s) missing end time — will not be included in export.';
  }else{warn.textContent='';}
}

// ═══════ TABS ═══════
function switchTab(name){
  document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.tabbar button').forEach(function(b){b.classList.remove('active');});
  document.getElementById('tab-'+name).classList.add('active');
  var btns=document.querySelectorAll('.tabbar button');
  if(name==='form')btns[0].classList.add('active');if(name==='map')btns[1].classList.add('active');
  if(name==='logs')btns[2].classList.add('active');if(name==='settings')btns[3].classList.add('active');
  if(name==='logs')renderLogs();if(name==='settings'){updateDataStats();updateExportPreview();}
  if(name==='map')setTimeout(function(){initMap();leafletMap.invalidateSize();updateUserMarker();},100);
}

// ═══════ UTILS ═══════
function v(id){return document.getElementById(id).value;}
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function unique(arr){var seen={},r=[];arr.forEach(function(v){if(!seen[v]){seen[v]=true;r.push(v);}});return r.sort();}
function toast(msg){var el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2000);}
</script>
</body>
</html>
